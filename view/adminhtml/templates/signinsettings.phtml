<!--
    This template file is for the Sign In settings.
    File acts as a view file for our Sign In settings.
-->
<?php
// Initialize all values
$customerLink = $this->showCustomerLink() ? 'checked' : '';
$adminLink = $this->showAdminLink() ? 'checked' : '';
$autoCreateAdmin = $this->autoCreateAdmin() ? 'checked' : '';
$autoCreateCustomer = $this->autoCreateCustomer() ? 'checked' : '';
$enableLoginRedirect = $this->isLoginRedirectEnabled() ? 'checked' : '';
$isOAuthConfigured = $this->isOAuthConfigured() && $this->isEnabled();
$disabled = $isOAuthConfigured ? '' : 'disabled title="Disabled. Configure your Service Provider"';
$logoutUrl = $this->getAdminLogoutUrl();
$enableDebugLog = $this->isDebugLogEnable() ? 'checked' : '';
?>

<div class="row">
    <div class="col-sm-7 page_margin">
        <div class="page" id="samlsettings">
            <div class="mosp_table_layout">
                <h3>LOGIN / LOGOUT OPTIONS</h3>
                <hr>
                <p style="font-style: italic; color: #666; margin-top: 10px;">
                    Configure login link visibility, user auto-creation, and redirect settings.
                </p>
            </div>

            <!-- Sign In Settings Form -->
            <form id="signInSettings" method="post" action="">
                <input name="form_key" type="hidden" value="<?= $block->escapeHtmlAttr($block->getFormKey()) ?>" />
                <input type="hidden" name="option" value="saveSignInSettings">

                <table>
                    <!-- Show Link on Default Login Page -->
                    <tr>
                        <td>
                            <label><strong>Show Link on Default Login Page:</strong></label>
                            <div style="margin-left:17px; margin-top:2%;">
                                <input type="checkbox"
                                       name="mo_oauth_show_customer_link"
                                       id="mo_oauth_show_customer_link"
                                       <?= $block->escapeHtmlAttr($customerLink) ?>
                                       value="true">
                                Show the Login Link on the default customer login page.
                                <br><br>
                                <input type="checkbox"
                                       name="mo_oauth_show_admin_link"
                                       id="mo_oauth_show_admin_link"
                                       <?= $block->escapeHtmlAttr($adminLink) ?>
                                       value="true">
                                Show the Login Link on the default admin login page.
                            </div>
                        </td>
                    </tr>

                    <!-- User Auto Create Settings -->
                    <tr>
                        <td>
                            <label><strong>User Auto Create Settings</strong></label>
                            <div style="margin-left:17px; margin-top:2%; width:100%;">
                                <input type="checkbox"
                                       name="mo_sso_auto_create_admin"
                                       id="mo_sso_auto_create_admin"
                                       <?= $block->escapeHtmlAttr($autoCreateAdmin) ?>
                                       value="true">
                                Auto Create Admin users while SSO, if they do not exist.
                                <br><br>
                                <input type="checkbox"
                                       name="mo_sso_auto_create_customer"
                                       id="mo_sso_auto_create_customer"
                                       <?= $block->escapeHtmlAttr($autoCreateCustomer) ?>
                                       value="true">
                                Auto Create Customer while SSO, if they do not exist.
                            </div>
                        </td>
                    </tr>

                    <!-- User Auto Redirect Settings -->
                    <tr>
                        <td>
                            <label><strong>User Auto Redirect Settings:</strong></label>
                            <div style="margin-left:17px; margin-top:2%; width:100%;">
                                <input type="checkbox"
                                       name="mo_saml_enable_login_redirect"
                                       id="mo_saml_enable_login_redirect"
                                       <?= $block->escapeHtmlAttr($enableLoginRedirect) ?>
                                       value="true"
                                       disabled="true"
                                       onchange="togglePostLogoutUrl()">
                                Check this option to auto redirect users to IDP from admin login page (if not logged in).
                                <br><br>
                                <div id="post_logout_url_container" style="<?= $enableLoginRedirect ? '' : 'opacity: 0.5;' ?>">
                                    <strong>Post-Logout URL for admin user:</strong>
                                    <span style="color: red;">*</span>
                                    <br>
                                    <input type="text"
                                           name="mo_oauth_logout_redirect_url"
                                           id="mo_oauth_logout_redirect_url"
                                           value="<?= $block->escapeHtmlAttr($logoutUrl) ?>"
                                           style="width: 300px; margin-top: 5px;"
                                           <?= $enableLoginRedirect ? 'required' : 'disabled' ?>>
                                    <br>
                                    <small style="color: #666;">Required when auto redirect is enabled.</small>
                                </div>
                            </div>
                        </td>
                    </tr>

                    <!-- Save Button -->
                    <tr>
                        <td>
                            <br>
                            <input type="button"
                                   class="btn-round"
                                   name="link_setup"
                                   title="You can only make changes if you have configured your SP"
                                   onclick="document.getElementById('signInSettings').submit();"
                                   value="Save"
                                   style="width:150px">
                        </td>
                    </tr>
                </table>
            </form>

            <!-- Debug Logs Section -->
            <br><br><br>
            <div class="mosp_table_layout">
                <h3>DEBUG LOGS</h3>
                <hr>
                <p style="font-style: italic; color: #666; margin-top: 10px;">
                    Enable logging and download debug information for troubleshooting.
                </p>
            </div>

            <!-- Enable Debug Log Form -->
            <form id="enable_debug_log" method="post" action="">
                <input name="form_key" type="hidden" value="<?= $block->escapeHtmlAttr($block->getFormKey()) ?>" />
                <input type="hidden" name="option" value="enable_debug_log">
                <br>
                <input type="checkbox"
                       name="debug_log_on"
                       <?= $block->escapeHtmlAttr($enableDebugLog) ?>
                       value="true">
                Enable Debug Log
                <input type="button"
                       class="btn-round"
                       name="enable_debug_log"
                       onclick="document.getElementById('enable_debug_log').submit();"
                       value="Submit"
                       style="width:110px; margin-left:30px">
            </form>

            <!-- Download/Clear Logs Form -->
            <form id="clear_download_logs" method="post" action="">
                <input name="form_key" type="hidden" value="<?= $block->escapeHtmlAttr($block->getFormKey()) ?>" />
                <input type="hidden" name="option" value="clear_download_logs">
                <p style="margin-top:20px; margin-left:10px">
                    The error logs will be cleared automatically on a weekly basis.
                </p>
                <div style="text-align:left">
                    <br>
                    <input type="submit"
                           class="btn-round"
                           name="download_logs"
                           value="Download Logs"
                           style="width:150px; margin-left:10px">
                    <input type="submit"
                           class="btn-round"
                           name="clear_logs"
                           value="Clear Logs"
                           style="width:150px; margin-left:10px">
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function togglePostLogoutUrl() {
    var checkbox = document.getElementById('mo_saml_enable_login_redirect');
    var urlInput = document.getElementById('mo_oauth_logout_redirect_url');
    var container = document.getElementById('post_logout_url_container');

    if (checkbox.checked) {
        urlInput.disabled = false;
        urlInput.required = true;
        container.style.opacity = '1';
    } else {
        urlInput.disabled = true;
        urlInput.required = false;
        container.style.opacity = '0.5';
    }
}
</script>
